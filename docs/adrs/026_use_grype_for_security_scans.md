# ADR: Use Grype for Security Scans

- **Date:** 2024-12-23
- **Status:** Accepted

## Context

We need a **reliable and efficient** way to conduct security scans against both:

1. **Source Code** dependencies (e.g., Python, Node.js, Go libraries).
2. **Container Images** (including OS-level packages).

Although we currently plan to generate [Software Bills of Materials (SBOMs)](https://github.com/anchore/syft) with **Syft**, we also need a dedicated **vulnerability scanning** tool. Scanning directly from an SBOM rather than re-inspecting the entire container or source code leads to **faster** and **more accurate** vulnerability detection.

**Key Points**:

- **Separate Scans**: We scan both **source code** (application libraries) and **container images** (OS packages, runtime dependencies).
- **Syft Integration**: By using Syft to generate an SBOM, a tool like **Grype** can consume the SBOM file (`sbom-source.json` or `sbom-image.json`) to quickly and accurately identify known vulnerabilities.

## Decision

We will **adopt [Grype](https://github.com/anchore/grype)** as our primary vulnerability scanner to leverage the **SBOM** files generated by **Syft**:

1. **Scan Source Code**:

   - Generate an SBOM from the local directory (e.g., `syft dir:./source -o json > sbom-source.json`).
   - Use Grype to scan that SBOM file: `grype sbom:sbom-source.json`.

2. **Scan Container Image**:

   - Build/pull the Docker image, then generate an SBOM (e.g., `syft docker:myorg/myimage:latest -o json > sbom-image.json`).
   - Use Grype to scan that SBOM file: `grype sbom:sbom-image.json`.

3. **Aggregate Results**:
   - The pipeline (e.g., GitHub Actions) will collect and analyze vulnerability reports for both **source** and **image**.
   - Potentially store these reports or fail the build if severity thresholds are exceeded (e.g., `--fail-on medium`).

## Alternatives Considered

1. **Direct Image/Directory Scanning** with Grype (no SBOM)

   - Still possible, but scanning from an SBOM is faster and more consistent, especially when reusing the SBOM for other audits.

2. **Other Vulnerability Scanners** (e.g., Trivy, Clair, Snyk)

   - These tools also detect vulnerabilities. However, Grype’s tight integration with Syft—plus open-source and local scanning capabilities—fits our needs well.

3. **Manual Security Review**
   - Developers manually track vulnerabilities or check known CVEs.
   - Impractical and error-prone for complex dependency graphs.

## Consequences

### Positive Outcomes

- **Faster, More Accurate Scans**: By scanning the **SBOM** generated by Syft, we avoid repeated inspection.
- **Automated CI/CD Integration**: Grype can be easily scripted into pipelines, with configurable thresholds for failing builds on high-severity issues.
- **Consistent Visibility**: Unified scanning approach for both source code and container images ensures no gaps in coverage.

### Potential Downsides

- **Additional Setup**: We must maintain Syft and Grype installations in our CI environment.
- **Learning Curve**: Teams must learn how to interpret Grype’s reports and address vulnerabilities.

## Related Work & References

- [Syft Documentation](https://github.com/anchore/syft) – used for SBOM generation.
- [Grype Documentation](https://github.com/anchore/grype) – used for vulnerability scanning.
